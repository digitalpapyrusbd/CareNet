<!DOCTYPE html>
<html>
<head>
    <title>Login Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Login Connection Test</h1>
    <div id="results"></div>
    <button onclick="runTests()">Run Tests</button>

    <script>
        const API_BASE_URL = 'http://localhost:4000';
        
        async function runTests() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Running tests...</p>';
            
            const tests = [];
            
            // Test 1: Backend Health
            tests.push(testBackendHealth());
            
            // Test 2: CORS
            tests.push(testCORS());
            
            // Test 3: Login Endpoint
            tests.push(testLoginEndpoint());
            
            // Test 4: API Client Endpoint Construction
            tests.push(testEndpointConstruction());
            
            const results_array = await Promise.all(tests);
            
            results.innerHTML = results_array.map(r => `
                <div class="test ${r.status}">
                    <h3>${r.name}</h3>
                    <p>${r.message}</p>
                    ${r.details ? `<pre>${JSON.stringify(r.details, null, 2)}</pre>` : ''}
                </div>
            `).join('');
        }
        
        async function testBackendHealth() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const data = await response.json();
                return {
                    name: 'Backend Health',
                    status: response.ok ? 'success' : 'error',
                    message: response.ok ? 'Backend is running' : `Backend returned ${response.status}`,
                    details: data
                };
            } catch (error) {
                return {
                    name: 'Backend Health',
                    status: 'error',
                    message: `Cannot connect to backend: ${error.message}`,
                    details: { error: error.message }
                };
            }
        }
        
        async function testCORS() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': 'http://localhost:3000',
                        'Access-Control-Request-Method': 'POST'
                    }
                });
                return {
                    name: 'CORS Configuration',
                    status: response.ok || response.status === 0 ? 'success' : 'error',
                    message: response.ok || response.status === 0 ? 'CORS is configured' : `CORS issue: ${response.status}`,
                    details: { status: response.status, headers: Object.fromEntries(response.headers.entries()) }
                };
            } catch (error) {
                return {
                    name: 'CORS Configuration',
                    status: 'info',
                    message: 'CORS test inconclusive (OPTIONS may not be supported)',
                    details: { error: error.message }
                };
            }
        }
        
        async function testLoginEndpoint() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': 'http://localhost:3000'
                    },
                    body: JSON.stringify({
                        phone: '+8801712345102',
                        password: 'Demo@123'
                    })
                });
                
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch {
                    data = { raw: text };
                }
                
                return {
                    name: 'Login Endpoint',
                    status: response.ok ? 'success' : 'error',
                    message: `Login endpoint responded with ${response.status}`,
                    details: {
                        status: response.status,
                        statusText: response.statusText,
                        response: data,
                        headers: Object.fromEntries(response.headers.entries())
                    }
                };
            } catch (error) {
                return {
                    name: 'Login Endpoint',
                    status: 'error',
                    message: `Cannot connect to login endpoint: ${error.message}`,
                    details: { error: error.message }
                };
            }
        }
        
        function testEndpointConstruction() {
            const testCases = [
                { input: '/auth/login', expected: '/api/auth/login' },
                { input: 'auth/login', expected: '/api/auth/login' },
                { input: '/api/auth/login', expected: '/api/auth/login' }
            ];
            
            const results = testCases.map(test => {
                let apiEndpoint;
                if (test.input.startsWith('/api/')) {
                    apiEndpoint = test.input;
                } else {
                    const cleanEndpoint = test.input.startsWith('/') ? test.input.slice(1) : test.input;
                    apiEndpoint = `/api/${cleanEndpoint}`;
                }
                
                return {
                    input: test.input,
                    expected: test.expected,
                    actual: apiEndpoint,
                    passed: apiEndpoint === test.expected
                };
            });
            
            const allPassed = results.every(r => r.passed);
            
            return {
                name: 'Endpoint Construction',
                status: allPassed ? 'success' : 'error',
                message: allPassed ? 'All endpoint constructions are correct' : 'Some endpoint constructions failed',
                details: { results }
            };
        }
    </script>
</body>
</html>

